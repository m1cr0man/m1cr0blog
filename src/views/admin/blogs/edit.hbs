{{> header }}
<header class="pure-u-1">
	<h1>Writing Post</h1>
</header>

<div class="pure-u-1">
	<form class="pure-g pure-form pure-form-stacked" action="" method="POST">
		<fieldset class="pure-u-1-4">
			<label for="title">Title</label>
			<input name="title" type="text" autocomplete="title" placeholder="Title" value="{{ blog.title }}" autofocus>
			<label for="url">URL</label>
			<input name="url" type="text" autocomplete="url" placeholder="URL" value="{{ blog.url }}">
			<label for="timestamp">Date</label>
			<input name="timestamp" type="date" value="{{ blog.htmlTimestamp }}">
			<label for="image">Primary image</label>
			<input name="image" type="text" autocomplete="image" placeholder="Primary image" value="{{ blog.image }}">
			<label for="tags">Tags</label>
			<input name="tags" type="text" autocomplete="tags" placeholder="Tags" value="{{ blog.tags }}">
			<br>
			<button type="submit" class="pure-button pure-button-success">{{#if blog}}Update{{else}}Add{{/if}}</button>
			<button type="button" onclick="preview();" class="pure-button pure-button-secondary">Preview</button>
		</fieldset>

		<fieldset class="pure-u-3-4">
			<label for="markdown">Body (Markdown)
				<textarea name="markdown" style="width: 100%;" rows="10">{{ blog.markdown }}</textarea>
			</label>
		</fieldset>
	</form>
</div>

<form id="image-uploader" class="pure-g pure-form pure-form-stacked" action="/api/v1/blogs/{{ blog.id }}/files"
	  method="POST"
	  enctype="multipart/form-data">
	<fieldset class="pure-u-1-4">
		<h2>Images</h2>
		<label for="upload-box">Upload Images</label>
		<input id="upload-box" name="file" type="file" accept="image/*">
	</fieldset>
	<div id="uploader-gallery" class="pure-u-3-4">
		<div class="hidden">
			<a><img src=""></a>
			<h3></h3>
			<button type="button" class="remover pure-button pure-button-error">Delete</button>
			<button type="button" class="appender pure-button pure-button-success">Insert</button>
			<button type="button" class="primary pure-button pure-button-secondary">Primary</button>
		</div>
		{{#each files}}
			<div data-name="{{ this }}">
				<a href="/posts/{{ ../blog.id }}/{{ this }}"><img src="/posts/{{ ../blog.id }}/{{ this }}"></a>
				<h3>{{ this }}</h3>
				<button type="button" class="remover pure-button pure-button-error"
						onclick="deleteFile('{{ this }}');">Delete
				</button>
				<button type="button" class="appender pure-button pure-button-success"
						onclick="appendFile('{{ this }}');">Insert
				</button>
				<button type="button" class="primary pure-button pure-button-secondary"
						onclick="setPrimary('{{ this }}');">Primary
				</button>
			</div>
		{{/each}}
	</div>
</form>

<article class="pure-u-1 blog-post">
	<header>
		<h1></h1>
		<time></time>
	</header>

	<hr>

	<figure class="primary-image">
		<img src='#'>
	</figure>

	<div></div>
</article>

<script type="text/javascript" src="https://unpkg.com/marked@0.5.1/marked.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript"
		src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
<script type='text/javascript'>
	function preview() {
		$('article h1').html($('[name=title]').val())
		$('article time').html((new Date()).toLocaleString())
		$('article img').attr('src', '/posts/{{ blog.id }}/' + $('[name=image]').val())
		$('article div').html(marked($('textarea').val()))
	}

	function uploadImage() {
		$('#image-uploader').ajaxSubmit({
			beforeSend: function () {
				var files = $('#image-uploader input')[0].files
				for (var i = 0; i < files.length; i++) {
					var file = files[i]
					var newItem = $('#uploader-gallery div.hidden').clone()
					newItem.children('a').attr('href', '/posts/{{ blog.id }}/' + file.name)
					newItem.children('button.remover').attr('onclick', 'deleteFile("' + file.name + '");')
					newItem.children('button.appender').attr('onclick', 'appendFile("' + file.name + '");')
					newItem.children('button.primary').attr('onclick', 'setPrimary("' + file.name + '");')
					newItem.children('h3').html(file.name)
					newItem.attr('data-name', file.name)
					newItem.removeClass('hidden')
					newItem.appendTo('#uploader-gallery')
				}
			},
			success: function () {
				$('#uploader-gallery a img').each(function () {
					$(this).attr('src', '/posts/{{ blog.id }}/' + $(this).parent().parent().attr('data-name'))
				})
			},
			error: function (err) {
				console.error(err || 'No response')
			}
		})
	}

	function appendFile(file) {
		var val = '<a href="/posts/{{ blog.id }}/' + file + '"><img src="/posts/{{ blog.id }}/' + file + '"></a>'
		return window.prompt('Ctrl+C -> Enter', val)
	}

	function setPrimary(file) {
		$('input[name=image]').val(file)
	}

	function deleteFile(name) {
		$.ajax({
			url: '/api/v1/blogs/{{ blog.id }}/files/' + name,
			method: 'delete',
			success: function () {
				$('[data-name="' + name + '"]').hide()
			}
		})
	}

	function updateUrl() {
		$('[name=url]').val(($('[name=title]').val() || '').toLowerCase().replace(/[^\w]+/g, '-'))
	}

	$(document).ready(function () {
		$('#image-uploader input').change(uploadImage)

		$('[name=title]').change(updateUrl)
	})
</script>
{{> footer }}
